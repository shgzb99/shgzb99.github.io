<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="英雄本色的博客，记录生活，分享感悟。">
<meta property="og:type" content="website">
<meta property="og:title" content="英雄本色的博客">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="英雄本色的博客">
<meta property="og:description" content="英雄本色的博客，记录生活，分享感悟。">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="英雄本色">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>英雄本色的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">英雄本色的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">记录生活，分享感悟</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-schedule">

    <a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>日程表</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/06/10/Shell-Script-to-Update-Cloudflare-Ddns/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="英雄本色">
      <meta itemprop="description" content="英雄本色的博客，记录生活，分享感悟。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="英雄本色的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/10/Shell-Script-to-Update-Cloudflare-Ddns/" class="post-title-link" itemprop="url">Shell Script to Update Cloudflare Ddns</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-06-10 20:09:21 / 修改时间：20:11:35" itemprop="dateCreated datePublished" datetime="2024-06-10T20:09:21+08:00">2024-06-10</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>转载 <a target="_blank" rel="noopener" href="https://echowings.github.io/zh-cn/p/shell-script-to-update-cloudflare-ddns/">https://echowings.github.io/zh-cn/p/shell-script-to-update-cloudflare-ddns/</a><br>Script</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">##############  User Configuration  ###############</span><br><span class="line"># Define programme path</span><br><span class="line"># location_path=&quot;/config/scripts/ddns&quot;</span><br><span class="line">location_path=$(dirname -- &quot;$0&quot;)</span><br><span class="line"></span><br><span class="line"># You Registered CloudFlare  Mail Account</span><br><span class="line">auth_email=&quot;&quot;</span><br><span class="line"></span><br><span class="line"># CloudFlare Global API Key</span><br><span class="line">auth_key=&quot;&quot;</span><br><span class="line"># Root Doman Name</span><br><span class="line">zone_name=&quot;&quot;</span><br><span class="line"></span><br><span class="line"># IP Type，Enter &#x27;ipv4&#x27; or &#x27;ipv6&#x27; ,at here we got paramter from our input</span><br><span class="line">type=$1</span><br><span class="line"></span><br><span class="line"># DDNS Domain Name</span><br><span class="line">record_name=$2</span><br><span class="line"></span><br><span class="line"># WAN INTERFACE</span><br><span class="line">INTERFACE=&quot;&quot;</span><br><span class="line"></span><br><span class="line">#############  Script  ############</span><br><span class="line"># The before WAN IP </span><br><span class="line">ip_file=&quot;$location_path/$1_$2_ip.txt&quot;</span><br><span class="line"></span><br><span class="line"># Domain id information</span><br><span class="line"># Domain id information</span><br><span class="line">id_file=&quot;$location_path/$1_$2_cloudflare.ids&quot;</span><br><span class="line"></span><br><span class="line"># Log location</span><br><span class="line">log_file=&quot;$location_path/cloudflare.log&quot;</span><br><span class="line"></span><br><span class="line">################  Don&#x27;t change here  ###############</span><br><span class="line">##################  Function  ####################</span><br><span class="line">record_type=&quot;&quot;</span><br><span class="line">ip=&quot;&quot;</span><br><span class="line">zone_identifier=&quot;&quot;</span><br><span class="line">record_identifier=&quot;&quot;</span><br><span class="line">update=&quot;&quot;</span><br><span class="line"></span><br><span class="line"># Log function</span><br><span class="line">log() &#123;</span><br><span class="line">    if [ &quot;$1&quot; ]; then</span><br><span class="line">        echo -e &quot;[$(date)] - $1&quot; &gt;&gt; $log_file</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line">#To get local IP address</span><br><span class="line">get_ip() &#123;</span><br><span class="line">    if [ $type == &quot;ipv4&quot; ]; then</span><br><span class="line">	    record_type=&quot;A&quot;</span><br><span class="line">	    ip=$(ip addr | grep $&#123;INTERFACE&#125;  -A2 | grep inet | grep -v inet6  | awk &#x27;&#123;print $2&#125;&#x27;)</span><br><span class="line">    elif [ $type == &quot;ipv6&quot; ]; then</span><br><span class="line">	    record_type=&quot;AAAA&quot;</span><br><span class="line">	    ip=$(ip addr | grep $&#123;INTERFACE&#125;  -A2 | grep inet6  | awk &#x27;&#123;print $2&#125;&#x27; | cut -d &#x27;/&#x27; -f1)</span><br><span class="line">    else</span><br><span class="line">	    echo &quot;Type wrong&quot;</span><br><span class="line">	    log &quot;Type wrong&quot;</span><br><span class="line">        exit 0</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Check IP changed or not, if there&#x27;s no change, then terminal programme</span><br><span class="line">check_ip_change() &#123;</span><br><span class="line">    if [ -f $ip_file ]; then</span><br><span class="line">        old_ip=$(cat $ip_file)</span><br><span class="line">        if [ &quot;$ip&quot; == &quot;$old_ip&quot; ]; then</span><br><span class="line">            echo &quot;IP has not changed.&quot;</span><br><span class="line">            log &quot;IP has not changed.&quot;</span><br><span class="line">            exit 0</span><br><span class="line">        fi</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line">#Get zone_id subdomain ID</span><br><span class="line">get_id() &#123;</span><br><span class="line">    if [ -f $id_file ] &amp;&amp; [ $(wc -l $id_file | cut -d &quot; &quot; -f 1) == 2 ]; then</span><br><span class="line">        zone_identifier=$(head -1 $id_file)</span><br><span class="line">        record_identifier=$(tail -1 $id_file)</span><br><span class="line">    else</span><br><span class="line">        zone_identifier=$(curl -s -X GET &quot;https://api.cloudflare.com/client/v4/zones?name=$zone_name&quot; -H &quot;X-Auth-Email: $auth_email&quot; -H &quot;X-Auth-Key: $auth_key&quot; -H &quot;Content-Type: application/json&quot; | grep -Po &#x27;(?&lt;=&quot;id&quot;:&quot;)[^&quot;]*&#x27; | head -1 )</span><br><span class="line">        rec_response_json=`curl -X GET &quot;https://api.cloudflare.com/client/v4/zones/$zone_identifier/dns_records?name=$record_name&quot; -H &quot;X-Auth-Email: $auth_email&quot; -H &quot;X-Auth-Key: $auth_key&quot; -H &quot;Content-Type: application/json&quot;`</span><br><span class="line">        record_identifier=`echo $rec_response_json | grep -Po &#x27;(?&lt;=&quot;id&quot;:&quot;)[^&quot;]*&#x27;`</span><br><span class="line">        echo &quot;$zone_identifier&quot; &gt; $id_file</span><br><span class="line">        echo &quot;$record_identifier&quot; &gt;&gt; $id_file</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line">#Update DNS record</span><br><span class="line">update_dns() &#123;</span><br><span class="line">    update=$(curl -s -X PUT &quot;https://api.cloudflare.com/client/v4/zones/$zone_identifier/dns_records/$record_identifier&quot; -H &quot;X-Auth-Email: $auth_email&quot; -H &quot;X-Auth-Key: $auth_key&quot; -H &quot;Content-Type: application/json&quot; --data &quot;&#123;\&quot;id\&quot;:\&quot;$zone_identifier\&quot;,\&quot;type\&quot;:\&quot;$record_type\&quot;,\&quot;name\&quot;:\&quot;$record_name\&quot;,\&quot;content\&quot;:\&quot;$ip\&quot;&#125;&quot;)</span><br><span class="line">&#125;</span><br><span class="line">###################  Main  ###################</span><br><span class="line">log &quot;Script start.&quot;</span><br><span class="line">#Got IP Address</span><br><span class="line">get_ip</span><br><span class="line"></span><br><span class="line"># Check got the right ip address</span><br><span class="line">if [ &quot;$ip&quot; == &quot;&quot; ]; then</span><br><span class="line">    echo &quot;Can not get IP address.Please check your network connection.&quot;</span><br><span class="line">    log &quot;Can not get IP address.Please check your network connection.&quot;</span><br><span class="line">    exit 0</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># Check IP changed or not</span><br><span class="line">check_ip_change</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Get zone_id and sumdomain record ID</span><br><span class="line">get_id</span><br><span class="line"></span><br><span class="line"># Check get ID successfully or not</span><br><span class="line">if [ &quot;$zone_identifier&quot; == &quot;&quot; ]; then</span><br><span class="line">    echo &quot;Can not get zone_id.&quot;</span><br><span class="line">    log &quot;Can not get zone_id.&quot;</span><br><span class="line">    exit 0</span><br><span class="line">elif [ &quot;$record_identifier&quot; == &quot;&quot; ]; then</span><br><span class="line">    echo &quot;Can not get record_id.&quot;</span><br><span class="line">    log &quot;Can not get record_id.&quot;</span><br><span class="line">    exit 0</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># Update DNS Record</span><br><span class="line">update_dns</span><br><span class="line"></span><br><span class="line"># Check DNS record updated or not</span><br><span class="line">if [[ $update == *&quot;\&quot;success\&quot;:false&quot;* ]]; then</span><br><span class="line">    log &quot;API UPDATE FAILED. DUMPING RESULTS:\n$update&quot;</span><br><span class="line">    echo -e &quot;API UPDATE FAILED. DUMPING RESULTS:\n$update&quot;</span><br><span class="line">    exit 0</span><br><span class="line">else</span><br><span class="line">    echo &quot;$ip&quot; &gt; $ip_file</span><br><span class="line">    log &quot;$record_name IP changed to: $ip&quot;</span><br><span class="line">    echo &quot;$record_name IP changed to: $ip&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<p>How to run the script</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#update A record</span><br><span class="line">sudo bash /config/scripts/ddns/cloudflare-ddns.sh ipv4 &lt;MY_DOMAIN_NAME&gt;</span><br><span class="line"></span><br><span class="line">#update AAAA record</span><br><span class="line">sudo bash /config/scripts/ddns/cloudflare-ddns.sh ipv6 &lt;MY_DOMAIN_NAME&gt;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/06/10/%E5%A6%82%E4%BD%95%E5%9C%A8Debian-12%E4%B8%8A%E5%AE%89%E8%A3%85Proxmox-VE-8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="英雄本色">
      <meta itemprop="description" content="英雄本色的博客，记录生活，分享感悟。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="英雄本色的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/10/%E5%A6%82%E4%BD%95%E5%9C%A8Debian-12%E4%B8%8A%E5%AE%89%E8%A3%85Proxmox-VE-8/" class="post-title-link" itemprop="url">如何在Debian 12上安装Proxmox VE 8</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-06-10 19:54:04 / 修改时间：20:06:14" itemprop="dateCreated datePublished" datetime="2024-06-10T19:54:04+08:00">2024-06-10</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>转载 <a target="_blank" rel="noopener" href="https://echowings.github.io/zh-cn/p/%E5%A6%82%E4%BD%95%E5%9C%A8debian-12%E4%B8%8A%E5%AE%89%E8%A3%85proxmox-ve-8/">https://echowings.github.io/zh-cn/p/%E5%A6%82%E4%BD%95%E5%9C%A8debian-12%E4%B8%8A%E5%AE%89%E8%A3%85proxmox-ve-8/</a><br>更改Debian 12的apt安装源</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"> #备份 /et/apt/source.list</span><br><span class="line">cp /etc/apt/sources.list /etc/apt/sources.list-bak</span><br><span class="line"></span><br><span class="line">#选项 1: 使用官方debian 12 源</span><br><span class="line">tee /etc/apt/sources.list &lt;&lt; &quot;EOF&quot;</span><br><span class="line">deb http://deb.debian.org/debian bookworm main non-free-firmware</span><br><span class="line">deb-src http://deb.debian.org/debian bookworm main non-free-firmware</span><br><span class="line"></span><br><span class="line">deb http://deb.debian.org/debian-security/ bookworm-security main non-free-firmware</span><br><span class="line">deb-src http://deb.debian.org/debian-security/ bookworm-security main non-free-firmware</span><br><span class="line"></span><br><span class="line">deb http://deb.debian.org/debian bookworm-updates main non-free-firmware</span><br><span class="line">deb-src http://deb.debian.org/debian bookworm-updates main non-free-firmware</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">#选项 2:使用中科大mirrors.utsc.edu.cn源</span><br><span class="line"># Downlaod and Install debian 12 sourcelist</span><br><span class="line">curl -fsSL https://mirrors.ustc.edu.cn/repogen/conf/debian-https-4-bookworm -o  /etc/apt/sources.list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apt update &amp;&amp; apt -y dist-upgrade</span><br><span class="line"></span><br><span class="line">apt install -y neovim net-tools</span><br></pre></td></tr></table></figure>

<p>网卡更名，把网卡名字还原为ethx(可选操作)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">export PATH=$PATH:/usr/sbin:/home/$(whoami)/.local/bin</span><br><span class="line">echo &quot;export PATH=$PATH:/usr/sbin:/home/$(whoami)/.local/bin&quot; &gt;&gt; ~/.bashrc</span><br><span class="line"></span><br><span class="line">cp /etc/default/grub /etc/default/grub-bak</span><br><span class="line">sed -i &#x27;/GRUB_CMDLINE_LINUX=/s/&quot;$/net.ifnames=0 biosdevname=0&quot;/&#x27; /etc/default/grub</span><br><span class="line"></span><br><span class="line">#更改网卡名字 enp2s0 更改为eth0，根据你实际网卡名字更改</span><br><span class="line">sed -i &#x27;s/enp2s0/eth0/&#x27; /etc/network/interfaces</span><br><span class="line">update-grub</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 重启系统生效</span><br><span class="line">systemctl reboot</span><br></pre></td></tr></table></figure>
<p>更改hosts文件的hostname</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ipv4_addr=$(ip -4 route get 8.8.8.8 | awk &#123;&#x27;print $7&#x27;&#125; | tr -d &#x27;\n&#x27;)</span><br><span class="line">echo $ipv4_addr</span><br><span class="line">sed -i &quot;s/127.0.1.1/$&#123;ipv4_addr&#125;/g&quot; /etc/hosts</span><br><span class="line">cat /etc/hosts </span><br><span class="line"></span><br><span class="line">hostname --ip-address</span><br></pre></td></tr></table></figure>
<p>更换PVE Sourcelist</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">#可选操作，2选1</span><br><span class="line">#选项 1: PVE官方sourcelist</span><br><span class="line">tee /etc/apt/sources.list.d/pve-install-repo.list &lt;&lt; &quot;EOF&quot;</span><br><span class="line">deb http://download.proxmox.com/debian/pve bookworm pve-no-subscription</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 选项2: 中科大国内镜像</span><br><span class="line">tee /etc/apt/sources.list.d/pve-install-repo.list &lt;&lt; &quot;EOF&quot;</span><br><span class="line">deb [arch=amd64] https://mirrors.ustc.edu.cn/proxmox/debian/pve bullseye pve-no-subscription</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">#安装gpg密钥</span><br><span class="line">#如下操作2选1</span><br><span class="line">#选项 1: 官方站点</span><br><span class="line">wget http://download.proxmox.com/debian/proxmox-release-bookworm.gpg  -O /etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg</span><br><span class="line"></span><br><span class="line">#选项2: 中科大镜像</span><br><span class="line">wget https://mirrors.ustc.edu.cn/proxmox/debian/proxmox-release-bookworm.gpg -O /etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#Ceph源更改</span><br><span class="line">#二选一</span><br><span class="line"></span><br><span class="line">#选项 1: pve官方源</span><br><span class="line">echo &quot;deb http://download.proxmox.com/debian/ceph-quincy bookworm no-subscription&quot; &gt; /etc/apt/sources.list.d/ceph.list</span><br><span class="line"></span><br><span class="line">#选项 2: 中科大国内镜像</span><br><span class="line">echo &quot;deb https://mirrors.ustc.edu.cn/proxmox/debian/ceph-quincy bookworm no-subscription&quot; &gt; /etc/apt/sources.list.d/ceph.list</span><br><span class="line"></span><br><span class="line"># 更新并安装</span><br><span class="line">apt update &amp;&amp; apt  -y full-upgrade</span><br><span class="line"></span><br><span class="line"># Install proxmxo ve kernel</span><br><span class="line">apt install pve-kernel-6.2</span><br><span class="line"></span><br><span class="line"># 重启系统</span><br><span class="line">systemctl reboot</span><br></pre></td></tr></table></figure>
<p>安装proxmox ve软件包</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 安装proxmox ve 软件包</span><br><span class="line">apt install -y  proxmox-ve postfix open-iscsi</span><br><span class="line"></span><br><span class="line">#移除debian 12的内核</span><br><span class="line">apt remove linux-image-amd64 &#x27;linux-image-6.1*&#x27;</span><br><span class="line">update-grub</span><br><span class="line"></span><br><span class="line"># 移除 OS-PROBER</span><br><span class="line">apt remove  -y os-prober</span><br><span class="line"></span><br><span class="line"># 关闭登录pve 未订阅提醒对话框</span><br><span class="line">sed -Ezi.bak &quot;s/(Ext.Msg.show\(\&#123;\s+title: gettext\(&#x27;No valid sub)/void\(\&#123; \/\/\1/g&quot; /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js &amp;&amp; systemctl restart pveproxy.service</span><br><span class="line"></span><br><span class="line"># 删除pve 企业源</span><br><span class="line">rm -f /etc/apt/sources.list.d/pve-enterprise.list</span><br><span class="line"></span><br><span class="line"># 安装 openvswitch-switch</span><br><span class="line">apt install -y  openvswitch-switch</span><br></pre></td></tr></table></figure>
<p>更改中科大 lxc模板源</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/share/perl5/PVE/APLInfo.pm /usr/share/perl5/PVE/APLInfo.pm_back</span><br><span class="line">sed -i &#x27;s|http://download.proxmox.com|https://mirrors.ustc.edu.cn/proxmox|g&#x27; /usr/share/perl5/PVE/APLInfo.pm</span><br></pre></td></tr></table></figure>
<p>参考文档<br><a target="_blank" rel="noopener" href="https://pve.proxmox.com/wiki/Install_Proxmox_VE_on_Debian_12_Bookworm">Install Proxmox VE on Debian 12 Bookworm</a><br><a target="_blank" rel="noopener" href="https://wiki.debian.org/SourcesList">Debian SourcesList</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/06/10/OpenWRT%E6%90%AD%E5%BB%BAOpenVPN%E6%9C%8D%E5%8A%A1%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="英雄本色">
      <meta itemprop="description" content="英雄本色的博客，记录生活，分享感悟。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="英雄本色的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/10/OpenWRT%E6%90%AD%E5%BB%BAOpenVPN%E6%9C%8D%E5%8A%A1%E5%99%A8/" class="post-title-link" itemprop="url">OpenWRT搭建OpenVPN服务器</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-06-10 11:44:49 / 修改时间：12:02:51" itemprop="dateCreated datePublished" datetime="2024-06-10T11:44:49+08:00">2024-06-10</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>转载 <a target="_blank" rel="noopener" href="https://www.vnf.cc/2019/11/openwrt-openvpn-server/">https://www.vnf.cc/2019/11/openwrt-openvpn-server/</a></p>
<p>本文主要实现在OpenWRT路由器系统下搭建OpenVPN服务器方便远程连接</p>
<p>之前一直是在OpenWRT使用Openconnect VPN,因为是SSLVPN使用起来结合CISCO的anyconnect客户端是很方便的，但是由于现在ISP连这种基于SSL的流量也有可以做识别并封公网IP，所以不得不考虑切换至基于UDP的OpenVPN了。</p>
<p>下面主要分三步：</p>
<p>（1）在OpenWRT安装并配置好OpenVPN</p>
<p>（2）配置多用户方案</p>
<p>（3）结合Luci去显示OpenVPN</p>
<p>那么现在开始吧，目前系统是使用了最新的OpenWRT 19.07.0-rc1, 同时适用于OpenWrt 18.06.4</p>
<p>1.在OpenWRT安装并配置好OpenVPN</p>
<p>先安装好本次所需的全部软件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">opkg update</span><br><span class="line">opkg install openvpn-easy-rsa openvpn-mbedtls luci-app-openvpn</span><br></pre></td></tr></table></figure>
<p>配置防火墙开放相应端口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># Configure firewall</span><br><span class="line">uci rename firewall.@zone[0]=&quot;lan&quot;</span><br><span class="line">uci rename firewall.@zone[1]=&quot;wan&quot;</span><br><span class="line">uci rename firewall.@forwarding[0]=&quot;lan_wan&quot;</span><br><span class="line">uci del_list firewall.lan.device=&quot;tun0&quot;</span><br><span class="line">uci add_list firewall.lan.device=&quot;tun0&quot;</span><br><span class="line">uci -q delete firewall.vpn</span><br><span class="line">uci set firewall.ovpn=&quot;rule&quot;</span><br><span class="line">uci set firewall.ovpn.name=&quot;Allow-OpenVPN&quot;</span><br><span class="line">uci set firewall.ovpn.src=&quot;wan&quot;</span><br><span class="line">uci set firewall.ovpn.dest_port=&quot;1194&quot;</span><br><span class="line">uci set firewall.ovpn.proto=&quot;udp&quot;</span><br><span class="line">uci set firewall.ovpn.target=&quot;ACCEPT&quot;</span><br><span class="line">uci commit firewall</span><br><span class="line">/etc/init.d/firewall restart</span><br><span class="line">OpenWRT Firewall</span><br></pre></td></tr></table></figure>

<p>生成服务器和客户端证书</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># Configuration parameters</span><br><span class="line">export EASYRSA_PKI=&quot;/etc/easy-rsa/pki&quot;</span><br><span class="line">export EASYRSA_REQ_CN=&quot;ovpnca&quot;</span><br><span class="line"> </span><br><span class="line"># Remove and re-initialize the PKI directory</span><br><span class="line">easyrsa --batch init-pki</span><br><span class="line"> </span><br><span class="line"># Generate DH parameters</span><br><span class="line"># 此步会较久</span><br><span class="line">easyrsa --batch gen-dh</span><br><span class="line"> </span><br><span class="line"># Create a new CA</span><br><span class="line">easyrsa --batch build-ca nopass</span><br><span class="line"> </span><br><span class="line"># Generate a keypair and sign locally for a server</span><br><span class="line">easyrsa --batch build-server-full server nopass</span><br><span class="line"> </span><br><span class="line"># Generate a keypair and sign locally for a client</span><br><span class="line">easyrsa --batch build-client-full client nopass</span><br></pre></td></tr></table></figure>
<p>生成服务器配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"># Generate TLS PSK</span><br><span class="line">OVPN_PKI=&quot;/etc/easy-rsa/pki&quot;</span><br><span class="line">openvpn --genkey --secret $&#123;OVPN_PKI&#125;/tc.pem</span><br><span class="line"> </span><br><span class="line"># Configuration parameters</span><br><span class="line">OVPN_DIR=&quot;/etc/openvpn&quot;</span><br><span class="line">OVPN_PKI=&quot;/etc/easy-rsa/pki&quot;</span><br><span class="line">OVPN_DEV=&quot;$(uci get firewall.lan.device | sed -e &quot;s/^.*\s//&quot;)&quot;</span><br><span class="line">OVPN_PORT=&quot;$(uci get firewall.ovpn.dest_port)&quot;</span><br><span class="line">OVPN_PROTO=&quot;$(uci get firewall.ovpn.proto)&quot;</span><br><span class="line">OVPN_POOL=&quot;192.168.8.0 255.255.255.0&quot;</span><br><span class="line">OVPN_DNS=&quot;$&#123;OVPN_POOL%.* *&#125;.1&quot;</span><br><span class="line">OVPN_DOMAIN=&quot;$(uci get dhcp.@dnsmasq[0].domain)&quot;</span><br><span class="line">OVPN_DH=&quot;$(cat $&#123;OVPN_PKI&#125;/dh.pem)&quot;</span><br><span class="line">OVPN_TC=&quot;$(sed -e &quot;/^#/d;/^\w/N;s/\n//&quot; $&#123;OVPN_PKI&#125;/tc.pem)&quot;</span><br><span class="line">OVPN_CA=&quot;$(openssl x509 -in $&#123;OVPN_PKI&#125;/ca.crt)&quot;</span><br><span class="line">NL=$&#x27;\n&#x27;</span><br><span class="line"> </span><br><span class="line"># Configure VPN server</span><br><span class="line">umask u=rw,g=,o=</span><br><span class="line">grep -l -r -e &quot;TLS Web Server Auth&quot; &quot;$&#123;OVPN_PKI&#125;/issued&quot; \</span><br><span class="line">| sed -e &quot;s/^.*\///;s/\.\w*$//&quot; \</span><br><span class="line">| while read -r OVPN_ID</span><br><span class="line">do</span><br><span class="line">OVPN_CERT=&quot;$(openssl x509 -in $&#123;OVPN_PKI&#125;/issued/$&#123;OVPN_ID&#125;.crt)&quot;</span><br><span class="line">OVPN_KEY=&quot;$(cat $&#123;OVPN_PKI&#125;/private/$&#123;OVPN_ID&#125;.key)&quot;</span><br><span class="line">cat &lt;&lt; EOF &gt; $&#123;OVPN_DIR&#125;/$&#123;OVPN_ID&#125;.conf</span><br><span class="line">verb 3</span><br><span class="line">user nobody</span><br><span class="line">group nogroup</span><br><span class="line">dev $&#123;OVPN_DEV&#125;</span><br><span class="line">port $&#123;OVPN_PORT&#125;</span><br><span class="line">proto $&#123;OVPN_PROTO&#125;</span><br><span class="line">server $&#123;OVPN_POOL&#125;</span><br><span class="line">topology subnet</span><br><span class="line">client-to-client</span><br><span class="line">keepalive 10 120</span><br><span class="line">persist-tun</span><br><span class="line">persist-key</span><br><span class="line">push &quot;dhcp-option DNS $&#123;OVPN_DNS&#125;&quot;</span><br><span class="line">push &quot;dhcp-option DOMAIN $&#123;OVPN_DOMAIN&#125;&quot;</span><br><span class="line">push &quot;redirect-gateway def1&quot;</span><br><span class="line">push &quot;persist-tun&quot;</span><br><span class="line">push &quot;persist-key&quot;</span><br><span class="line">&lt;dh&gt;$&#123;NL&#125;$&#123;OVPN_DH&#125;$&#123;NL&#125;&lt;/dh&gt;</span><br><span class="line">&lt;tls-crypt&gt;$&#123;NL&#125;$&#123;OVPN_TC&#125;$&#123;NL&#125;&lt;/tls-crypt&gt;</span><br><span class="line">&lt;ca&gt;$&#123;NL&#125;$&#123;OVPN_CA&#125;$&#123;NL&#125;&lt;/ca&gt;</span><br><span class="line">&lt;cert&gt;$&#123;NL&#125;$&#123;OVPN_CERT&#125;$&#123;NL&#125;&lt;/cert&gt;</span><br><span class="line">&lt;key&gt;$&#123;NL&#125;$&#123;OVPN_KEY&#125;$&#123;NL&#125;&lt;/key&gt;</span><br><span class="line">EOF</span><br><span class="line">done</span><br><span class="line">/etc/init.d/openvpn restart</span><br></pre></td></tr></table></figure>
<p>OVPN_POOL&#x3D;”192.168.8.0 255.255.255.0” 定义的地址池不要和内网已有的地址冲突 push “redirect-gateway def1” 是将OpenVPN的网关作为默认网关，会创建默认路由指向OpenVPN的网关，如果只是需要访问家里的网络，可将这条按需要修改，如push “route 192.168.1.0 255.255.255.0 192.168.8.1”</p>
<p>用ip addr show tun0和cat &#x2F;var&#x2F;run&#x2F;openvpn.server.status确认一下OpenVPN运行状态</p>
<p>OpenVPN Status</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">生成客户端ovpn文件</span><br><span class="line"></span><br><span class="line"># 先确定使用DDNS还是公网IP作为OpenVPN连接使用，并配置好OVPN_SERV参数，本次以DDNS地址为例子</span><br><span class="line">OVPN_SERV=&quot;ddns.example.com&quot;</span><br><span class="line"></span><br><span class="line"># Configuration parameters</span><br><span class="line">OVPN_DIR=&quot;/etc/openvpn&quot;</span><br><span class="line">OVPN_PKI=&quot;/etc/easy-rsa/pki&quot;</span><br><span class="line">OVPN_DEV=&quot;$(uci get firewall.lan.device | sed -e &quot;s/^.*\s//&quot;)&quot;</span><br><span class="line">OVPN_PORT=&quot;$(uci get firewall.ovpn.dest_port)&quot;</span><br><span class="line">OVPN_PROTO=&quot;$(uci get firewall.ovpn.proto)&quot;</span><br><span class="line">OVPN_TC=&quot;$(sed -e &quot;/^#/d;/^\w/N;s/\n//&quot; $&#123;OVPN_PKI&#125;/tc.pem)&quot;</span><br><span class="line">OVPN_CA=&quot;$(openssl x509 -in $&#123;OVPN_PKI&#125;/ca.crt)&quot;</span><br><span class="line">NL=$&#x27;\n&#x27;</span><br><span class="line"> </span><br><span class="line"># Generate VPN client profiles</span><br><span class="line">umask u=rw,g=,o=</span><br><span class="line">grep -l -r -e &quot;TLS Web Client Auth&quot; &quot;$&#123;OVPN_PKI&#125;/issued&quot; \</span><br><span class="line">| sed -e &quot;s/^.*\///;s/\.\w*$//&quot; \</span><br><span class="line">| while read -r OVPN_ID</span><br><span class="line">do</span><br><span class="line">OVPN_CERT=&quot;$(openssl x509 -in $&#123;OVPN_PKI&#125;/issued/$&#123;OVPN_ID&#125;.crt)&quot;</span><br><span class="line">OVPN_KEY=&quot;$(cat $&#123;OVPN_PKI&#125;/private/$&#123;OVPN_ID&#125;.key)&quot;</span><br><span class="line">cat &lt;&lt; EOF &gt; $&#123;OVPN_DIR&#125;/$&#123;OVPN_ID&#125;.ovpn</span><br><span class="line">verb 3</span><br><span class="line">dev $&#123;OVPN_DEV%%[0-9]*&#125;</span><br><span class="line">nobind</span><br><span class="line">client</span><br><span class="line">remote $&#123;OVPN_SERV&#125; $&#123;OVPN_PORT&#125; $&#123;OVPN_PROTO&#125;</span><br><span class="line">auth-nocache</span><br><span class="line">remote-cert-tls server</span><br><span class="line">&lt;tls-crypt&gt;$&#123;NL&#125;$&#123;OVPN_TC&#125;$&#123;NL&#125;&lt;/tls-crypt&gt;</span><br><span class="line">&lt;ca&gt;$&#123;NL&#125;$&#123;OVPN_CA&#125;$&#123;NL&#125;&lt;/ca&gt;</span><br><span class="line">&lt;cert&gt;$&#123;NL&#125;$&#123;OVPN_CERT&#125;$&#123;NL&#125;&lt;/cert&gt;</span><br><span class="line">&lt;key&gt;$&#123;NL&#125;$&#123;OVPN_KEY&#125;$&#123;NL&#125;&lt;/key&gt;</span><br><span class="line">EOF</span><br><span class="line">done</span><br><span class="line">ls $&#123;OVPN_DIR&#125;/*.ovpn</span><br></pre></td></tr></table></figure>
<p>将该ovpn导入到OpenVPN的客户端就可以链接上OpenVPN服务器</p>
<p>Connection Status</p>
<p>至此一般的OpenVPN Server配置已经完成，目前存在的问题就是一个证书只能连接上一个客户端，下一步就是将会配置多用户的方案。</p>
<p>2.多用户模式</p>
<p>多用户方案有两种，一种是生成多个证书文件，每个用户单独使用一个证书；另外一种就是使用单证书配合用户密码的形式。</p>
<p>这两种都会贴一下配置，因为连回家主要是为了方便，所以会以用户名密码的方式为主。</p>
<p>多证书方式：</p>
<p>需要生成另外一组用户公钥和私钥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Configuration parameters</span><br><span class="line">export EASYRSA_PKI=&quot;/etc/easy-rsa/pki&quot;</span><br><span class="line"> </span><br><span class="line"># Add one more client</span><br><span class="line">easyrsa --batch build-client-full client1 nopass</span><br></pre></td></tr></table></figure>
<p>然后在&#x2F;etc&#x2F;easy-rsa&#x2F;pki&#x2F;issued找到client1.crt,在&#x2F;etc&#x2F;easy-rsa&#x2F;pki&#x2F;private找到client1.key</p>
<p>将client1.crt的cert和client1.key的key替换ovpn文件中的段即可生成给第二位用户的ovpn文件</p>
<p>单证书多用户模式：</p>
<p>创建用户认证脚本(checkpsw.sh)</p>
<p>&#x2F;etc&#x2F;openvpn&#x2F;checkpsw.sh</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">###########################################################</span><br><span class="line"># checkpsw.sh (C) 2004 Mathias Sundman &lt;mathias@openvpn.se&gt;</span><br><span class="line">#</span><br><span class="line"># This script will authenticate OpenVPN users against</span><br><span class="line"># a plain text file. The passfile should simply contain</span><br><span class="line"># one row per user with the username first followed by</span><br><span class="line"># one or more space(s) or tab(s) and then the password.</span><br><span class="line"></span><br><span class="line">PASSFILE=&quot;/etc/openvpn/psw-file&quot;</span><br><span class="line">LOG_FILE=&quot;/etc/openvpn/openvpn-password.log&quot;</span><br><span class="line">TIME_STAMP=`date &quot;+%Y-%m-%d %T&quot;`</span><br><span class="line"></span><br><span class="line">###########################################################</span><br><span class="line"></span><br><span class="line">if [ ! -r &quot;$&#123;PASSFILE&#125;&quot; ]; then</span><br><span class="line">  echo &quot;$&#123;TIME_STAMP&#125;: Could not open password file \&quot;$&#123;PASSFILE&#125;\&quot; for reading.&quot; &gt;&gt; $&#123;LOG_FILE&#125;</span><br><span class="line">  exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">CORRECT_PASSWORD=`awk &#x27;!/^;/&amp;&amp;!/^#/&amp;&amp;$1==&quot;&#x27;$&#123;username&#125;&#x27;&quot;&#123;print $2;exit&#125;&#x27; $&#123;PASSFILE&#125;`</span><br><span class="line"></span><br><span class="line">if [ &quot;$&#123;CORRECT_PASSWORD&#125;&quot; = &quot;&quot; ]; then </span><br><span class="line">  echo &quot;$&#123;TIME_STAMP&#125;: User does not exist: username=\&quot;$&#123;username&#125;\&quot;, password=\&quot;$&#123;password&#125;\&quot;.&quot; &gt;&gt; $&#123;LOG_FILE&#125;</span><br><span class="line">  exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ &quot;$&#123;password&#125;&quot; = &quot;$&#123;CORRECT_PASSWORD&#125;&quot; ]; then </span><br><span class="line">  echo &quot;$&#123;TIME_STAMP&#125;: Successful authentication: username=\&quot;$&#123;username&#125;\&quot;.&quot; &gt;&gt; $&#123;LOG_FILE&#125;</span><br><span class="line">  exit 0</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">echo &quot;$&#123;TIME_STAMP&#125;: Incorrect password: username=\&quot;$&#123;username&#125;\&quot;, password=\&quot;$&#123;password&#125;\&quot;.&quot; &gt;&gt; $&#123;LOG_FILE&#125;</span><br><span class="line">exit 1</span><br></pre></td></tr></table></figure>
<p>配置执行权限</p>
<p>chmod +x &#x2F;etc&#x2F;openvpn&#x2F;checkpsw.sh</p>
<p>配置用户密码文件</p>
<p>&#x2F;etc&#x2F;openvpn&#x2F;psw-file</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user1 passwd1</span><br><span class="line">user2 passwd2</span><br></pre></td></tr></table></figure>
<p>修改服务端配置文件</p>
<p>在&#x2F;etc&#x2F;openvpn&#x2F;server.conf后面添加</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">script-security 3</span><br><span class="line">auth-user-pass-verify /etc/openvpn/checkpsw.sh via-env</span><br><span class="line">username-as-common-name</span><br><span class="line">verify-client-cert none</span><br></pre></td></tr></table></figure>
<p>修改客户端配置文件</p>
<p>删除掉<cert>和<key></p>
<p>添加如下内容:</p>
<p>auth-user-pass</p>
<p>那样就可以使用用户密码登录了。</p>
<p>3.OpenWRT Luci集成</p>
<p>这一步主要是方便在OpenWRT的Web界面方便看到OpenVPN的状态信息</p>
<p>确保已经安装好</p>
<p>opkg install luci-app-openvpn</p>
<p>通过命令修改luci配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># Provide VPN instance management</span><br><span class="line">ls /etc/openvpn/*.conf \</span><br><span class="line">| while read -r OVPN_CONF</span><br><span class="line">do</span><br><span class="line">OVPN_ID=&quot;$(basename $&#123;OVPN_CONF%.*&#125; | sed -e &quot;s/\W/_/g&quot;)&quot;</span><br><span class="line">uci -q delete openvpn.$&#123;OVPN_ID&#125;</span><br><span class="line">uci set openvpn.$&#123;OVPN_ID&#125;=&quot;openvpn&quot;</span><br><span class="line">uci set openvpn.$&#123;OVPN_ID&#125;.enabled=&quot;1&quot;</span><br><span class="line">uci set openvpn.$&#123;OVPN_ID&#125;.config=&quot;$&#123;OVPN_CONF&#125;&quot;</span><br><span class="line">done</span><br><span class="line">uci commit openvpn</span><br><span class="line">/etc/init.d/openvpn restart</span><br></pre></td></tr></table></figure>
<p>Luci Status</p>
<p>refer:</p>
<p>1.<a target="_blank" rel="noopener" href="https://openwrt.org/docs/guide-user/services/vpn/openvpn/basic">OpenVPN basic</a></p>
<p>2.<a target="_blank" rel="noopener" href="http://www.89cool.com/811.html">Openvpn 2.4 设置用户密码认证</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/06/10/%E5%A6%82%E4%BD%95%E4%BC%98%E9%9B%85%E5%9C%B0%E7%AE%A1%E7%90%86-GitHub-%E4%B8%8A-star-%E7%9A%84%E9%A1%B9%E7%9B%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="英雄本色">
      <meta itemprop="description" content="英雄本色的博客，记录生活，分享感悟。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="英雄本色的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/10/%E5%A6%82%E4%BD%95%E4%BC%98%E9%9B%85%E5%9C%B0%E7%AE%A1%E7%90%86-GitHub-%E4%B8%8A-star-%E7%9A%84%E9%A1%B9%E7%9B%AE/" class="post-title-link" itemprop="url">如何优雅地管理 GitHub 上 star 的项目</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-06-10 09:48:03 / 修改时间：16:30:58" itemprop="dateCreated datePublished" datetime="2024-06-10T09:48:03+08:00">2024-06-10</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>转载 <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/150889781">https://zhuanlan.zhihu.com/p/150889781</a></p>
<h3 id="如何优雅地管理-GitHub-上-star-的项目"><a href="#如何优雅地管理-GitHub-上-star-的项目" class="headerlink" title="如何优雅地管理 GitHub 上 star 的项目"></a>如何优雅地管理 GitHub 上 star 的项目</h3><p>GitHub Star管理工具很多,或是插件,或是网站.我想,纯文本还是最简单的方法,如果把它以一定格式导出来,发布到知乎专栏上可能更方便查看和分享,下面谈做法.</p>
<h3 id="安装PyGithub"><a href="#安装PyGithub" class="headerlink" title="安装PyGithub"></a>安装PyGithub</h3><p>pip install PyGithub</p>
<h3 id="导出stars-csv"><a href="#导出stars-csv" class="headerlink" title="导出stars.csv"></a>导出stars.csv</h3><p>这里使用github上的export-stars项目来导出. <a target="_blank" rel="noopener" href="https://github.com/JeffCarpenter/export-stars">github.com&#x2F;JeffCarpenter&#x2F;export-stars</a></p>
<p>GH_USER&#x3D;yourGithubusername python3 export_stars.py &gt; stars.csv</p>
<h3 id="由csv文本转markdown格式并用split分割"><a href="#由csv文本转markdown格式并用split分割" class="headerlink" title="由csv文本转markdown格式并用split分割"></a>由csv文本转markdown格式并用split分割</h3><p>stars.csv内容例如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/TheAlgorithms/C,All Algorithms implemented in C </span><br><span class="line">https://github.com/TheAlgorithms/C-Plus-Plus,All Algorithms implemented in C++</span><br><span class="line">https://github.com/mitmath/1806,18.06 course at MIT</span><br><span class="line">用sed过滤器将其转换为markdown的链接形式,这里用了捕获组这点小知识.</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed &quot;s#\(https://github.com/\)\([^,]*\),#- [\2](\1\2)#g&quot; test.txt</span><br></pre></td></tr></table></figure>
<p>转换之后</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- [TheAlgorithms/C](https://github.com/TheAlgorithms/C)All Algorithms implemented in C </span><br><span class="line">- [TheAlgorithms/C-Plus-Plus](https://github.com/TheAlgorithms/C-Plus-Plus)All Algorithms implemented in C++</span><br><span class="line">- [mitmath/1806](https://github.com/mitmath/1806)18.06 course at MIT</span><br></pre></td></tr></table></figure>
<p>sed可以用-i选项直接改源文件.这里只列了三行,假设stars.csv里有1800行,那么-l参数设300可以把文件拆成 6份.我这样做了,一个个以markdown导出来,发在另一个专栏中,感兴趣的小伙伴可以看看.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed -i &quot;s#\(https://github.com/\)\([^,]*\),#- [\2](\1\2)#g&quot; stars.csv </span><br><span class="line">split -l 300 stars.csv</span><br></pre></td></tr></table></figure>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a target="_blank" rel="noopener" href="https://github.com/JeffCarpenter/export-stars">github.com&#x2F;JeffCarpenter&#x2F;export-stars</a><br><a target="_blank" rel="noopener" href="https://github.com/PyGithub/PyGithub">PyGithub&#x2F;PyGithub</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/06/10/linux%20find%20-regex%20%E4%BD%BF%E7%94%A8%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="英雄本色">
      <meta itemprop="description" content="英雄本色的博客，记录生活，分享感悟。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="英雄本色的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/10/linux%20find%20-regex%20%E4%BD%BF%E7%94%A8%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" class="post-title-link" itemprop="url">linux find -regex 使用正则表达式</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-06-10 06:44:39 / 修改时间：16:32:29" itemprop="dateCreated datePublished" datetime="2024-06-10T06:44:39+08:00">2024-06-10</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/jiangzhaowei/p/5451173.html">https://www.cnblogs.com/jiangzhaowei/p/5451173.html</a></p>
<p>find之强大毋庸置疑，此处只是带领大家一窥find门径，更详细的说明见man  find和 info find。<br>整篇文章循序渐进，从最常用的文件名测试项开始步步深入，到第六节基本讲完find处理文件的规则，再之后的章节是一些常用表达式的说明。<br>（此篇中所有选项及例子基于GNU find version 4.2.28）</p>
<p>（一）Get Start<br>最简单的find用法莫过于如此：</p>
<p>$ find .<br>查找当前目录下的所有文件。<br>find命令的一般格式为：</p>
<p>find [-H] [-L] [-P] [path…] [expression]</p>
<p>其中，’-H’ ‘-L’ ‘-P’三个选项主要是用来处理符号连接，’-H’表示只跟随命令行中指定的符号连接，’-L’表示跟随所有的符号连接，’-P’是默认的选项，表示不跟随符号连接。<br>例如，在我的当前目录下有一个符号连接e1000，现在我想查找文件名中最后一个字母是数字的源文件，那么</p>
<p>$ find -H . -name “*[0-9].c” -print<br>.&#x2F;2234.c<br>像上面这样写只能查找出当前目录下符合要求的文件，却找不出e1000下的文件。因此可以这么写：</p>
<p>$ find -H e1000 . -name “*[0-9].c” -print<br>或者使用 ‘-L’选项</p>
<p>$ find -L . -name “*[0-9].c” -print</p>
<p>格式中的[path…]部分表示以此目录为根目录进行搜索。</p>
<p>格式中的[expression]是一个表达式。最基本的表达式分为三类：设置项(option)、测试项(test)、动作项(action)，这三类又可以通过逻辑运算符(operator)组合在一起形成更大更复杂的表达式。设置项（如-depth,-maxdepth等）针对这次查找任务，而不是仅仅针对某一个文件，设置项总是返回true；测试项(test)则不同，它针对具体的一个文件进行匹配测试，如-name,-num,-user等，返回true或者false；动作项(action)则是对某一个文件进行某种动作（最常见的如-print），返回true或者false。<br>正是[expression]部分的丰富，才使得find如此强大。此部分较复杂，后面慢慢说明。</p>
<p>（二）文件名<br>根据文件名来查找一个文件是大家经常遇到的事情，第一节中的’-name’正是解决此问题的。<br>-name属于表达式中的测试项(test)，它按照文件名模式来匹配文件，若匹配则返回true，否则返回false。最好用引号将文件名模式引起来，防止shell自己解析要匹配的字符串。（可以用单引号也可以用双引号，单引号和双引号在shell环境中的区别见后续部分）<br>例如，想要的当前目录及子目录中查找文件名以一个大写字母开头或者以小写a或b开头的文件，可以用：</p>
<p>$ find . -name “[A-Za-b]*” -print<br>.&#x2F;a_book_of_c.chm<br>.&#x2F;TMP1234<br>如果想在当前目录查找文件名不以大写字母开头，之后跟一个小写字母，再之后是两个数字，最后是.txt的文件，可以这么用：</p>
<p>$ find . -name “[^A-Z][a-z][0-9][0-9].txt” -print<br>.&#x2F;@y38.txt<br>注意：此处的模式匹配并不符合正则表达式。</p>
<p>-name对大小写字母敏感，如果想匹配时不考虑大小写可以使用-iname测试项。’i’可以加在许多选项前面，比如-ipath,-iregex,-iwholename等等，都是表示大小写不敏感。</p>
<p>（三）正则表达式<br>使用上面的-name测试项能解决许多问题，但是有些还是不太好办，比如：查找当前目录下名称全部为数字的c源代码文件，这时就该’-regex’出手了。正则表达式绝对值得你去好好研究一下，在unix系统下太有用了，这里不做过多说明，请读者自行学习。<br>-regex同样属于测试项。使用-regex时有一点要注意：-regex不是匹配文件名，而是匹配完整的文件名（包括路径）。例如，当前目录下有一个文件”abar9”，如果你用”ab.*9”来匹配，将查找不到任何结果，正确的方法是使用”.*ab.<em>9”或者”.</em>&#x2F;ab.*9”来匹配。<br>针对上面的那个查找c代码的问题，可以这么写：</p>
<p>$ find . -regex “.<em>&#x2F;[0-9]</em>&#x2F;.c” -print<br>.&#x2F;2234.c</p>
<p>还有一个设置项(option)’-regextype’，可以让你根据自己的喜好选择使用的正则表达式类型，大家可以试试。</p>
<p>（四）wholename与path<br>既然上一节提到了完整文件名（包括路径名），那么这里不妨说一下-wholename和-path。<br>-wholename和-path都属于测试项(test)，而且功能也一样。-path从字面上看给人一种错觉，好像只匹配路径名（或者目录名），其实它也可以匹配文件名，因此-wholename这个名字更贴切一些。<br>看看这个例子，当前目录下有一个phone目录，phone目录里有一个文件名称是puk.txt，使用-path：</p>
<p>$ find . -path ‘<em>phone&#x2F;pu</em>‘<br>.&#x2F;phone&#x2F;puk.txt</p>
<p>另外要提一点：使用-path的一般格式是：find [path …] -path pattern …<br>它的意思是：在[path …]部分指明的路径上，使用pattern匹配所有文件的完整文件名；而不是说在类似的pattern目录下查找文件。</p>
<p>（五）逻辑运算符<br>有了上面三个选项，你现在应该对文件名的相关匹配得心应手了，对于不是很复杂的查找应该也胜任了。但是看看这个例子，解释一下它在做什么？</p>
<p>$ find . -size +0c -wholename “<em>e</em>[0-9]*” -o ! &#x2F;( -name “.” -o -name “<em>phone” &#x2F;) -prune  -name “</em>.c” -user xixi -o -name “*phone”<br>下面是当前目录下的所有文件：</p>
<p>$ ls -l<br>total 224<br>-rw-r–r– 1 xixi  admin      0 2007-11-01 17:34 0dfe.c<br>-rw-r–r– 1 abc admin      0 2007-10-30 15:56 0s8a.txt<br>-rw-r–r– 1 abc admin      0 2007-11-04 01:00 0TMP123<br>-rw-r–r– 1 abc admin     73 2007-11-05 15:33 2234.c<br>-rw-r–r– 1 abc admin     72 2007-11-05 15:34 3e10.c<br>-rw——- 1 abc admin 224017 2006-03-16 12:16 a_book_of_c.chm<br>lrwxrwxrwx 1 abc admin     15 2007-11-04 11:48 e1000 -&gt; ..&#x2F;e1000-7.6.9&#x2F;<br>-rw-r–r– 1 abc admin     70 2007-11-05 14:57 e100.dat<br>lrwxrwxrwx 1 abc admin     13 2007-11-05 14:59 e100puk.txt -&gt; phone&#x2F;puk.txt<br>-rw-r–r– 1 abc admin      0 2007-11-06 22:21 e680phone<br>drwxr-xr-x 2 abc admin     37 2007-11-06 22:24 phone<br>drwxr-xr-x 2 abc admin     20 2007-11-07 01:07 phone1<br>drwxr-xr-x 2 abc admin      6 2007-11-05 15:37 phone2<br>-rw-r–r– 1 abc admin     67 2007-11-04 12:23 @y38.txt</p>
<p>phone$ ls -l<br>total 4<br>-rw-r–r– 1 abc admin  0 2007-11-06 22:24 e680gphone<br>-rw——- 1 abc admin 38 2007-11-05 14:58 puk.txt</p>
<p>phone1$ ls -l<br>total 0<br>-rw-r–r– 1 xixi admin 0 2007-11-07 01:07 hello.c</p>
<p>phone2$ ls -l<br>total 0</p>
<p>要想解决上面的问题就得学习一下find中的逻辑运算符。逻辑运算符主要有以下几个，按照优先级从高到低的顺序如下：<br> ( expr )</p>
<p>括号优先级最高，首先对括号内的求值<br> ! expr</p>
<p>对expr表达式的值取反<br> -not expr</p>
<p>同上，但是POSIX不支持<br> expr1 expr2</p>
<p>不加任何运算符，相当于两个之间加and，即与运算，两个表达式值都为true整个才返回true。先对expr1表达式求值，若为false，则不对expr2求值。<br> expr1 -a expr2</p>
<p>同上<br> expr1 -and expr2</p>
<p>同上，但是POSIX不支持<br> expr1 -o expr2</p>
<p>表示对expr1和expr2两个表达式的值求或，左右两个值只要有一个为ture，整个表达式就是true。先对expr1表达式求值，若为ture，则不对expr2求值。<br> expr1 -or expr2</p>
<p>同上，但是POSIX不支持<br> expr1 , expr2</p>
<p>逗号表达式。expr1和expr2都会求值，但是只返回expr2的值，expr1的值会被丢弃</p>
<p>正是因为有一个求值的顺序，所以你才有可能见到这样的写法：</p>
<p>$ find . -name “<em>.txt” -o -print<br>表示，如果表达式-name “</em>.txt”为真，就不再执行另一个表达式-print，即查找所有不是以.txt结尾的文件。</p>
<p>再有，要查找当前目录下，文件名中包括字母’e’，在’e’之后又有数字的不是目录文件的所有文件，可以这么写：</p>
<p>$ find . -name “<em>e</em>[0-9]*” ! -type d -print<br>.&#x2F;e1000<br>.&#x2F;e100.dat<br>.&#x2F;e100puk.txt<br>.&#x2F;3e10.c<br>大家可以自己多举几个例子试一下。</p>
<p>（六）-prune<br>-prune是一个动作项，它表示当文件是一个目录文件时，不进入此目录进行搜索。<br>要理解-prune动作，首先得理解find命令的搜索规则（也可以说find命令的算法）。<br>find命令递归遍历所指定的目录树，针对每个文件依次执行find命令中的表达式，表达式首先根据逻辑运算符进行结合，然后依次从左至右对表达式求值。以下面代码为例，进行说明</p>
<p>find PATHP1 OPT1 TEST1 ACT1 ( TEST2 or TEST3 ) ACT2<br>(1) 根据OPT1设置项进行find命令的整体设置，若没有-depth设置项，依次进行下面的步骤<br>(2) 令文件变量File &#x3D; PATHP1<br>(3) 对File文件进行TEST1测试，若执行结果为false，转(8)<br>(4) 对File文件进行ACT1动作，若执行结果为false，转(8)<br>(5) 对File文件进行TEST2测试，若执行结果为true，转(7)<br>(6) 对File文件进行TEST3测试，若执行结果为false，转(8)<br>(7) 对File文件进行ACT2动作<br>(8) 若File文件是一个目录，并且没有被执行过-prune动作，则进入此目录<br>(9) 当前目录下是否还有文件，若有依次取一个文件，令File指向此文件，转(3)；<br>(10) 判断当前目录是否是PATHP1，若是则程序退出；若不是，则返回上一层目录，转(9)</p>
<p>理解了上面的流程，那么不难理解下面的代码为什么只输出一个’.’</p>
<p>$ find . -prune<br>.<br>再有，当前目录下大于4090字节的文件有两个，而大于4096字节的文件只有一个，如下：</p>
<p>$ find . -size +4090c -print<br>.<br>.&#x2F;a_book_of_c.chm</p>
<p>$ find . -size +4096c -print<br>.&#x2F;a_book_of_c.chm</p>
<p>那么，将上面两个-print都替换为-prune，这两条命令分别输出什么？</p>
<p>$ find . -size +4090c -prune<br>.<br>$ find . -size +4096c -prune<br>.&#x2F;a_book_of_c.chm<br>这就是答案，如果你答对了，恭喜你，你已经掌握了find命令！</p>
<p>-prune经常和-path或-wholename一起使用，以避开某个目录，常见的形式是：</p>
<p>$ find PATH (-path &lt;don’t want this path #1&gt; -o -path &lt;don’t want this path #2&gt;) -prune -o -path <global expression for what I do want></p>
<p>注意:如果同时使用-depth设置项，那么-prune将被find命令忽略。man手册页中这么说：”If -depth is given, false; no effect.”<br>说到这里，又得说说-depth设置项。网上好多资料说-depth设置项的功能是“在查找文件时，首先查找当前目录中的文件，然后再在其子目录中查找”，这明显是错误的，man手册页中如是说：”-depth Process each directory’s  contents before the directory itself.”。这有点像树的后序遍历，先遍历当前节点的所有子节点，然后再访问当前节点…<br>考考你：<br>下面的命令输出什么？为什么？</p>
<p>$ find . -depth -prune -name “*.c” -print</p>
<p>（七）时间戳<br>理解了上面几节，你已经掌握了find命令的“道” ^_^ ，下面这几节只是介绍一些常用、好用的“招式”。这一节介绍时间戳。</p>
<p>文件有三个时间属性：创建时间、最近修改时间、最近访问时间。<br>最近修改时间又包括两种，一是文件的状态（也即权限如rwx等）最近被修改时间，一是文件的数据（也即内容）最近被修改时间。touch命令改变的即是文件数据最近被修改时间。<br>最近访问时间，指的是最近一次文件数据（内容）被访问的时间。因此，使用ls命令输出文件的相关信息并不会修改文件的最近访问时间。</p>
<p>find命令提供了针对文件的最近访问时间、文件状态最近被修改时间、文件数据最近被修改时间进行匹配的测试项，分别是-amin, -cmin, -mmin和-atime, -ctime, -mtime两组，第一组基于分钟，第二组基于天。<br>以-amin为例，假设当前时间tnow&#x3D;”2007-11-12 14:42:10”、t1&#x3D;”2007-11-12 14:39:10”、t2&#x3D;”2007-11-12 14:40:10”，那么要查找最近访问时间属于[t1,t2]时间段的文件，可以这么写：</p>
<p>$ find . -amin 3</p>
<p>若测试项参数是数字，则基本上都可以在数字参数前加”+”或者”-“号，表示“大于”或“小于”的意思，因此，要查找最近访问时间属于[t1,tnow]时间段的文件，可以这么写：</p>
<p>$ find . -amin -3</p>
<p>“-amin n”和”-atime n”的处理方法都是：根据当前时间和文件的相应时间属性求n值，然后比较n值和参数n，看是否符合要求。但是这个求n值的过程却有很大不同，他们的不同也代表了两组（基于分钟和基于天）的不同：<br>“-amin n”</p>
<p>1、求Δt，用当前时间减去文件对应属性的时间值即得到Δt，Δt &#x3D; tnow - tfile;<br>2、求浮点数f，用Δt除以1分钟，f &#x3D; Δt &#x2F; 1min;<br>3、将f的小数部分入到整数部分，得到n。即，不管f是6.0102还是6.8901，n都等于7<br>“-atime n”</p>
<p>1、求Δt，用当前时间减去文件对应属性的时间值即得到Δt，Δt &#x3D; tnow - tfile;<br>2、求浮点数f，用Δt处以24小时，f &#x3D; Δt &#x2F; 24hours;<br>3、将f的小数部分都舍掉，得到n。即，不管f是6.0102还是6.8901，n都等于6<br>大家可以多做实验，试一下。</p>
<p>（八）权限位<br>很多人都在用windows，从windows系统拷过来的文件经常被加上了可执行权限，比如我现在想把主目录下所有的后缀名为.txt .pdf .rm并且具有可执行权限位的文件查找出来，该怎么写呢？<br>这里就不得不说一说权限位测试项：-perm。-perm支持符号权限位表示法也支持绝对（八进制）权限位表示法，但是最好使用八进制的权限表示法（这只是个建议  ^_^ ）。<br>-perm基本上有下面这几中形式：</p>
<p>-perm mode       File’s  permission  bits  are  exactly mode.<br>-perm -mode     All  of the permission bits mode are set for the file.<br>-perm &#x2F;mode     Any of the permission bits mode are set for the file.<br>-perm +mode (此形式已经不推荐使用，功能与&#x2F;mode相同)<br>好好理解上面蓝色部分，理解了，-perm测试项也就掌握了。<br>考考你：<br>看看下面这句话是什么意思？</p>
<p>find . -perm -444 -perm &#x2F;222 ! -perm &#x2F;111</p>
<p>现在再来解决本节最开始提出的问题：查找主目录下所有的后缀名为.txt .pdf .rm并且具有可执行权限位的文件。</p>
<p>$ find ~ &#x2F;( -name “<em>.txt” -o -name “</em>.pdf” -o -name “*.rm” &#x2F;)  &#x2F;<br>   -not &#x2F;( -type d -o -type l &#x2F;)  &#x2F;<br>   -perm &#x2F;111 -print</p>
<p>（九）文件类型<br>有一个问题：我只想查找符号连接文件，可是查找结果中却包括了普通文件、目录文件等等，不相关的东西太多了，怎么把不是符号连接文件的查找结果去掉？<br>-type测试项刚好可以满足你的要求，-type c即可，其中c表示文件类型，find中支持如下类型：</p>
<pre><code>          b      block (buffered) special
          c      character (unbuffered) special
          d      directory
          p      named pipe (FIFO)
          f       regular file
          l       symbolic link;
          s      socket
          D     door (Solaris)
</code></pre>
<p>针对上面的问题，可以这么写：</p>
<p>$ find . -name “e100*” -type l -print<br>.&#x2F;e1000<br>.&#x2F;e100puk.txt<br>但是，不要这么写：</p>
<p>$ find -L . -name “e100*” -type l -print<br>加上’-L’选项之后，你将查不到需要的东西，除非符号连接已经失效了。</p>
<p>（十）文件大小<br>前面一再使用-size测试项，这里简单介绍一下。<br>-size测试项根据文件的大小查找文件，文件大小既可以用块（block）来计量，也可以用字节来计量。默认情况下以块计量文件大小，若想使用字节来计量只需要在数字参数后加c即可。find支持的其他计量方式有：<br>-size n[cwbkMG]，分别表示</p>
<pre><code>          ‘b’    for 512-byte blocks (this is the default if no suffix  is used)
          ‘c’    for bytes
          ‘w’    for two-byte words
          ‘k’    for Kilobytes (units of 1024 bytes)
          ‘M’    for Megabytes (units of 1048576 bytes)
          ‘G’    for Gigabytes (units of 1073741824 bytes)
</code></pre>
<p>（十一）用户、用户组<br>根据用户、用户组来查找文件，这个没有太多要说的，记住命令格式即可：</p>
<p>-uid n<br>-user username or uid<br>-nouser<br>-gid n<br>-group gname or gid<br>-nogroup</p>
<p>（十二）输出格式<br>如果你不想查找到你想要的文件事单调的输出文件名，你可以使用-printf动作项输出你想要的格式，下面举几个-printf动作的参数：</p>
<p>%p    输出文件名，包括路径名<br>%f     输出文件名，不包括路径名<br>%m    以8进制方式输出文件的权限<br>%g    输出文件所属的组<br>%h    输出文件所在的目录名<br>%u    输出文件的属主名<br>…<br>例如：</p>
<p>$ find . -user xixi -printf “%m %p &#x2F;&#x2F;n”<br>644 .&#x2F;phone1&#x2F;hello.c<br>644 .&#x2F;0dfe.c </p>
<p>其余的，看man手册页吧。</p>
<p>（十三）执行外部命令<br>这又是一个很容易出彩的地方。find真是强大，对查找到的文件竟然可以调用外部命令进行处理。-exec动作项就是来完成这个功能的，格式是：</p>
<p>find . EXPR1 -exec command {} &#x2F;;<br>注意：后一个花括号’}’和’&#x2F;‘之间有一个空格。<br>例如，查找当前目录下的所有普通文件，并用ls命令输出：</p>
<p>find . -type f -exec ls -l {} &#x2F;;<br>有些操作系统中出于安全考虑只允许-exec选项执行诸如l s或ls -l这样的命令。<br>也可以使用-exec动作项的安全模式：-ok动作项。它的功能和语法都跟-exec一样，只不过它以更安全的模式运行，当要删除文件时，它会给出提示，让你选择到底删除还是不删。<br>例如：</p>
<p>$ find logs -name “<em>abc</em>“ -ok rm {} &#x2F;;</p>
<p>使用-exec动作项处理匹配到的文件时，find命令会将所有匹配到的文件一起传递给exec执行。但有些系统对能够传递给exec的命令长度有限制，这样在find命令运行几分钟之后，就会出现溢出错误。错误信息通常是“参数列太长”或“参数列溢出”。这就是xargs命令的用处所在，特别是与find命令一起使用。<br>xargs的使用格式是：</p>
<p>find PATH EXPR1 EXPR2 | xargs command<br>利用管道，把find命令匹配到的文件名传递给xargs命令，而xargs命令每次只获取一部分文件而不是全部。这样它可以先处理最先获取的一部分文件，然后是下一批，并如此继续下去。<br>在有些系统中，使用-exec动作项会为处理每一个匹配到的文件而发起一个相应的进程，并非将匹配到的文件全部作为参数一次执行；这样在有些情况下就会出现进程过多，系统性能下降的问题，因而效率不高；而使用xargs命令则只有一个进程。另外，在使用xargs命令时，究竟是一次获取所有的参数，还是分批取得参数，以及每一次获取参数的数目都会根据该命令的选项及系统内核中相应的可调参数来确定。<br>例如，要在普通文件中查找文件内容中包含”io”的文件，可以这么写：</p>
<p>$ find . -type f | xargs grep “io”<br>Binary file .&#x2F;a_book_of_c.chm matches<br>.&#x2F;2234.c:#include &lt;stdio.h&gt;<br>.&#x2F;3e10.c:#include &lt;stdio.h&gt;</p>
<p>find命令配合exec和xargs可以对所匹配到的文件执行几乎所有的命令。</p>
<p>（十四）总结<br>理解并运用find，关键是掌握find命令的处理规则（见第五节）：递归遍历所指定的目录树，针对每个文件依次执行find命令中的表达式，表达式首先根据逻辑运算符进行结合，然后依次从左至右对表达式求值。把这个理解了，需要什么功能查一下man就可以了。</p>
<p>find命令还有好多功能这里没有涉及到，具体的大家看man手册页吧。在任何时候，man都是一个极好的帮助工具。   ^_^</p>
<p>（十五）附<br>第五节提出的问题，答案如下:</p>
<p>$ find . -size +0c -wholename “<em>e</em>[0-9]*” -o   &#x2F;<br>         !  &#x2F;( -name “.” -o -name “<em>phone” &#x2F;) -prune  -name “</em>.c” -user xixi   &#x2F;<br>         -o -name “*phone”<br>.&#x2F;e1000<br>.&#x2F;e100.dat<br>.&#x2F;phone<br>.&#x2F;phone&#x2F;e680gphone<br>.&#x2F;e100puk.txt<br>.&#x2F;3e10.c<br>.&#x2F;phone1<br>.&#x2F;phone1&#x2F;hello.c<br>.&#x2F;phone2<br>.&#x2F;0dfe.c<br>.&#x2F;e680phone</p>
<p>这篇文章断断续续写了好久，今天终于基本完工。参考了man手册页以及一些网上的资料。<br>要把自己心中所想有条理的写出来感觉真是不易，希望对大家有所帮助。<br>欢迎批评指正。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/06/09/%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2%EF%BC%9A%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%8A%E7%BA%BF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="英雄本色">
      <meta itemprop="description" content="英雄本色的博客，记录生活，分享感悟。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="英雄本色的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/09/%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2%EF%BC%9A%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%8A%E7%BA%BF/" class="post-title-link" itemprop="url">搭建个人博客：从零到上线</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-06-09 23:53:36" itemprop="dateCreated datePublished" datetime="2024-06-09T23:53:36+08:00">2024-06-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-06-10 00:08:58" itemprop="dateModified" datetime="2024-06-10T00:08:58+08:00">2024-06-10</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>使用 Docker 搭建个人博客：从零到上线<br>小奇 青檬小栈 2024-06-08 08:05 安徽<br>图片<br><a target="_blank" rel="noopener" href="https://mmbiz.qpic.cn/sz_mmbiz_gif/Ric3gNzlqMktFY107ObFDRpgSatYsoyjHXrcxj4bBw7FcG1d2BrbzcD6mTaMzEMDTsMdvXVibaIdOelTBURThtibw/640?wx_fmt=gif&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1">图片</a><br>图片<img src="https://mmbiz.qpic.cn/sz_mmbiz_gif/Ric3gNzlqMkvPnXywsoHaF81F6JictPpR89bRVz2LQ63JTlYhEPXpicIr5icOAxCMlgB57HTL0UVwjW2gPElV87Y9Q/640?wx_fmt=gif&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1"><br>在当今数字时代，拥有一个个人博客不仅能展示你的技术和思想，还能为你提供一个记录和分享的平台。</p>
<p>Docker 作为一种流行的容器化技术，可以让你快速、轻松地部署和管理你的博客。</p>
<p>在本文中，我们将详细介绍如何使用 Docker 从零开始搭建个人博客。</p>
<p>图片</p>
<p>目录</p>
<ol>
<li><p>前提条件</p>
</li>
<li><p>选择博客平台</p>
</li>
<li><p>环境准备</p>
</li>
<li><p>克隆博客仓库</p>
</li>
<li><p>编写 Docker Compose 文件</p>
</li>
<li><p>配置环境变量</p>
</li>
<li><p>启动容器</p>
</li>
<li><p>访问博客</p>
</li>
<li><p>自定义博客</p>
</li>
<li><p>总结</p>
</li>
</ol>
<p>前提条件<br>在开始之前，请确保你的系统已经安装了以下工具：</p>
<ol>
<li><p>Docker[1]</p>
</li>
<li><p>Docker Compose[2]</p>
</li>
</ol>
<p>这些工具的安装可以参考各自的官方文档。如果您是初次接触 Docker，可以先了解一下 Docker 的基本概念和命令。</p>
<p>选择博客平台<br>我们选择了 Hexo[3] 作为我们的博客平台。Hexo 是一个快速、简洁且高效的博客框架，支持 Markdown 语法，并且有丰富的主题和插件可供选择。</p>
<p>环境准备<br>首先，我们需要为 Hexo 创建一个工作目录，并初始化一个 Hexo 项目。打开终端并运行以下命令：</p>
<p>mkdir my-blog<br>cd my-blog<br>npm install hexo-cli -g<br>hexo init<br>npm install<br>这些命令将创建一个新的 Hexo 项目，并安装所有必要的依赖项。接下来，我们将准备 Docker 环境。</p>
<p>克隆博客仓库<br>为了方便管理和部署，我们将博客项目托管在 GitHub 上。首先，创建一个新的 GitHub 仓库，然后将本地 Hexo 项目推送到该仓库。</p>
<p>git init<br>git remote add origin <a target="_blank" rel="noopener" href="https://github.com/yourusername/yourblog.git">https://github.com/yourusername/yourblog.git</a><br>git add .<br>git commit -m “Initial commit”<br>git push -u origin master<br>编写 Docker Compose 文件<br>我们将使用 Docker Compose 来管理多个 Docker 容器。创建一个名为 docker-compose.yml 的文件，并添加以下内容：</p>
<p>version: ‘3.8’</p>
<p>services:<br>  hexo:<br>    image: node:14<br>    container_name: hexo_blog<br>    working_dir: &#x2F;usr&#x2F;src&#x2F;app<br>    volumes:<br>      - .:&#x2F;usr&#x2F;src&#x2F;app<br>    command: sh -c “npm install &amp;&amp; hexo server -p 4000”<br>    ports:<br>      - “4000:4000”<br>这个 Docker Compose 文件定义了一个名为 hexo 的服务，使用官方的 Node.js 镜像，并将当前目录挂载到容器内。启动容器时，将安装依赖并启动 Hexo 服务器。</p>
<p>配置环境变量<br>为了方便管理配置，我们可以将一些环境变量放入 .env 文件中。创建一个 .env 文件，并添加以下内容：</p>
<p>BLOG_PORT&#x3D;4000<br>然后，在 docker-compose.yml 文件中引用这些环境变量：</p>
<p>version: ‘3.8’</p>
<p>services:<br>  hexo:<br>    image: node:14<br>    container_name: hexo_blog<br>    working_dir: &#x2F;usr&#x2F;src&#x2F;app<br>    volumes:<br>      - .:&#x2F;usr&#x2F;src&#x2F;app<br>    command: sh -c “npm install &amp;&amp; hexo server -p ${BLOG_PORT}”<br>    ports:<br>      - “${BLOG_PORT}:${BLOG_PORT}”<br>启动容器<br>现在我们可以使用 Docker Compose 启动容器了。运行以下命令：</p>
<p>docker-compose up -d<br>该命令会在后台启动 Hexo 容器。你可以使用以下命令查看容器的状态：</p>
<p>docker-compose ps<br>如果一切顺利，你应该会看到 Hexo 容器正在运行。</p>
<p>访问博客<br>打开浏览器，并访问 <a href="http://localhost:4000，你应该会看到">http://localhost:4000，你应该会看到</a> Hexo 的默认欢迎页面。 当然，我们继续深入探讨如何自定义和管理你的 Hexo 博客，包括更改主题、添加插件和部署到生产环境。</p>
<p>图片</p>
<p>图片</p>
<p>自定义博客<br>更改主题<br>Hexo 有许多精美的主题，你可以在 Hexo 主题库[4] 中找到。以下是更改主题的步骤。</p>
<ol>
<li><p>选择主题：在 Hexo 主题库中选择一个你喜欢的主题，并记下其安装命令或 GitHub 仓库地址。</p>
</li>
<li><p>安装主题：在你的博客根目录下运行安装命令。例如，安装 NexT 主题：</p>
</li>
</ol>
<p>git clone <a target="_blank" rel="noopener" href="https://github.com/theme-next/hexo-theme-next">https://github.com/theme-next/hexo-theme-next</a> themes&#x2F;next<br>3. 配置主题：打开 Hexo 配置文件 _config.yml，更改主题配置：</p>
<p>theme: next<br>4. 自定义主题：进入 themes&#x2F;next 目录，根据主题文档自定义配置，例如更改配色、布局等。</p>
<p>添加插件<br>Hexo 提供了丰富的插件系统，可以扩展博客的功能。以下是添加插件的步骤：</p>
<ol>
<li><p>选择插件：在 Hexo 插件库[5] 中选择需要的插件。</p>
</li>
<li><p>安装插件：在博客根目录下运行安装命令。例如，安装 Hexo SEO 插件：</p>
</li>
</ol>
<p>npm install hexo-generator-seo-friendly-sitemap –save<br>3. 配置插件：根据插件文档，打开 _config.yml 文件，添加相应的配置。例如，配置 SEO 插件：</p>
<p>sitemap:<br>  path: sitemap.xml<br>部署到生产环境<br>将你的博客部署到云服务器或静态网站托管服务（如 GitHub Pages、Netlify）上，可以让全世界的人访问。以下是一些常见的部署方法。</p>
<p>部署到 GitHub Pages</p>
<ol>
<li>安装部署插件：在博客根目录下运行以下命令：</li>
</ol>
<p>npm install hexo-deployer-git –save<br>2. 配置部署插件：在 _config.yml 文件中添加部署配置：</p>
<p>deploy:<br>  type: git<br>  repo: <a target="_blank" rel="noopener" href="https://github.com/yourusername/yourblog.git">https://github.com/yourusername/yourblog.git</a><br>  branch: gh-pages<br>3. 生成静态文件并部署：运行以下命令：</p>
<p>hexo clean<br>hexo generate<br>hexo deploy<br>部署到 Netlify</p>
<ol>
<li><p>创建 Netlify 帐号：访问 Netlify[6] 创建一个免费帐号。</p>
</li>
<li><p>连接 GitHub 仓库：在 Netlify 仪表盘中创建一个新站点，并选择你的 GitHub 仓库。</p>
</li>
<li><p>配置构建设置：设置构建命令为 hexo generate，发布目录为 public。</p>
</li>
<li><p>部署站点：保存并部署，Netlify 会自动从你的仓库中拉取代码并部署。</p>
</li>
</ol>
<p>持续集成和自动部署<br>为了简化部署过程，你可以使用持续集成工具（如 GitHub Actions）来实现自动化部署。</p>
<p>使用 GitHub Actions 自动部署</p>
<ol>
<li>创建 GitHub Actions 工作流文件：在你的仓库中创建 .github&#x2F;workflows&#x2F;deploy.yml 文件，并添加以下内容：</li>
</ol>
<p>name: Deploy Hexo Blog</p>
<p>on:<br>  push:<br>    branches:<br>      - master</p>
<p>jobs:<br>  build:<br>    runs-on: ubuntu-latest</p>
<pre><code>steps:
- name: Checkout code
  uses: actions/checkout@v2

- name: Setup Node.js
  uses: actions/setup-node@v1
  with:
    node-version: &#39;14&#39;

- name: Install dependencies
  run: npm install

- name: Generate static files
  run: npm run build

- name: Deploy to GitHub Pages
  uses: peaceiris/actions-gh-pages@v3
  with:
    github_token: $&#123;&#123; secrets.GITHUB_TOKEN &#125;&#125;
    publish_dir: ./public
</code></pre>
<ol start="2">
<li><p>配置 GitHub Secrets：在你的 GitHub 仓库设置中，添加 GITHUB_TOKEN 到 Secrets 中。</p>
</li>
<li><p>推送代码：每次将代码推送到 master 分支时，GitHub Actions 会自动运行工作流并部署你的博客。</p>
</li>
</ol>
<p>访问博客<br>在部署完成后，你可以通过配置的域名或托管服务提供的默认域名访问你的博客。</p>
<p>自定义博客<br>自定义域名<br>如果你希望使用自定义域名而不是默认的 GitHub Pages 或 Netlify 域名，你可以按照以下步骤进行设置。</p>
<p>在 GitHub Pages 上使用自定义域名</p>
<ol>
<li><p>购买域名：你可以通过域名注册商（如 Namecheap、GoDaddy）购买一个域名。</p>
</li>
<li><p>配置 DNS：在你的域名注册商的管理控制台中，添加一个 CNAME 记录，指向 yourusername.github.io。例如：</p>
</li>
</ol>
<p>CNAME record:<br>Name: www<br>Value: yourusername.github.io<br>3. 添加 CNAME 文件：在你的 Hexo 项目根目录下创建一个名为 CNAME 的文件，内容为你的自定义域名，例如：</p>
<p><a target="_blank" rel="noopener" href="http://www.yourdomain.com/">www.yourdomain.com</a><br>4. 部署：再次运行 hexo deploy 命令，将 CNAME 文件部署到 GitHub Pages。</p>
<p>在 Netlify 上使用自定义域名</p>
<ol>
<li><p>购买域名：同样，你需要通过域名注册商购买一个域名。</p>
</li>
<li><p>添加域名到 Netlify：在 Netlify 仪表盘中，进入你的站点设置，找到 “Domain management” 并添加你的自定义域名。</p>
</li>
<li><p>配置 DNS：Netlify 会提供 DNS 记录配置指导，你需要在域名注册商的管理控制台中添加相应的 DNS 记录，例如 A 记录或 CNAME 记录。</p>
</li>
</ol>
<p>添加评论系统<br>一个互动的博客通常会包含评论系统。Hexo 支持多种评论系统，例如 Disqus 和 Gitalk。以下以 Disqus 为例：</p>
<ol>
<li><p>注册 Disqus：访问 Disqus[7] 并创建一个新的站点。</p>
</li>
<li><p>获取 Disqus Shortname：在 Disqus 的设置中找到 Shortname，它是你站点的唯一标识符。</p>
</li>
<li><p>配置 Hexo：在 Hexo 的 _config.yml 文件中添加 Disqus 配置：</p>
</li>
</ol>
<p>disqus_shortname: your-disqus-shortname<br>4. 安装 Disqus 插件：如果你的主题不支持 Disqus 评论系统，你可能需要安装 Hexo Disqus 插件：</p>
<p>npm install hexo-disqus –save<br>添加搜索功能<br>为了让读者更容易找到他们感兴趣的文章，你可以为博客添加搜索功能。例如，使用 hexo-generator-searchdb 插件：</p>
<ol>
<li>安装插件：</li>
</ol>
<p>npm install hexo-generator-searchdb –save<br>2. 配置插件：在 Hexo 的 _config.yml 文件中添加以下配置：</p>
<p>search:<br>  path: search.xml<br>  field: post<br>  format: html<br>3. 修改主题：根据你使用的主题文档，添加搜索框和相应的 JS 代码来启用搜索功能。</p>
<p>优化性能<br>为了提升博客的加载速度和性能，可以进行以下优化：</p>
<p>启用 CDN<br>使用内容分发网络（CDN）可以加速你博客的静态资源加载。例如，使用 Cloudflare：</p>
<ol>
<li><p>注册 Cloudflare：访问 Cloudflare[8] 并注册一个新账户。</p>
</li>
<li><p>添加站点：按照提示添加你的自定义域名，并更新域名注册商的 DNS 服务器设置为 Cloudflare 提供的 DNS 服务器。</p>
</li>
<li><p>启用 CDN：确保 Cloudflare 的 CDN 功能已启用，并配置缓存规则。</p>
</li>
</ol>
<p>压缩资源<br>压缩 CSS、JS 和图片等静态资源可以显著减少页面加载时间。你可以使用 Hexo 插件来实现资源压缩：</p>
<ol>
<li>安装压缩插件：</li>
</ol>
<p>npm install hexo-neat –save<br>2. 配置插件：在 Hexo 的 _config.yml 文件中添加以下配置：</p>
<p>neat_enable: true<br>neat_html:<br>  enable: true<br>  exclude:<br>neat_css:<br>  enable: true<br>  exclude:<br>neat_js:<br>  enable: true<br>  exclude:<br>备份和恢复<br>定期备份你的博客项目是个好习惯，可以防止数据丢失。你可以使用 Git 来管理备份。</p>
<p>使用 GitHub 备份</p>
<ol>
<li>确保项目在 GitHub 上：之前我们已经将 Hexo 项目推送到 GitHub 仓库，这里简单回顾一下：</li>
</ol>
<p>git init<br>git remote add origin <a target="_blank" rel="noopener" href="https://github.com/yourusername/yourblog.git">https://github.com/yourusername/yourblog.git</a><br>git add .<br>git commit -m “Initial commit”<br>git push -u origin master</p>
<ol>
<li>定期提交和推送：每次对博客进行修改后，记得提交并推送到 GitHub：</li>
</ol>
<p>git add .<br>git commit -m “Update blog content”<br>git push<br>恢复博客<br>如果需要恢复你的博客，只需从 GitHub 克隆仓库并安装依赖：</p>
<p>git clone <a target="_blank" rel="noopener" href="https://github.com/yourusername/yourblog.git">https://github.com/yourusername/yourblog.git</a><br>cd yourblog<br>npm install<br>常见问题解决<br>Docker 容器无法启动<br>如果遇到 Docker 容器无法启动的情况，可以查看容器日志来诊断问题：</p>
<p>docker-compose logs hexo<br>常见问题可能包括依赖安装失败、端口冲突等。根据日志信息进行相应的调整和修复。</p>
<p>Hexo 部署失败<br>如果在部署到 GitHub Pages 或其他平台时失败，可以尝试以下步骤：</p>
<ol>
<li><p>检查配置文件：确保 _config.yml 中的配置正确，特别是 deploy 部分。</p>
</li>
<li><p>清理缓存和生成文件：</p>
</li>
</ol>
<p>hexo clean<br>hexo generate</p>
<ol>
<li>重新部署：</li>
</ol>
<p>hexo deploy<br>主题样式不生效<br>如果更改主题或自定义样式后没有生效，可以尝试以下步骤：</p>
<ol>
<li>清理缓存和生成文件：</li>
</ol>
<p>hexo clean<br>hexo generate</p>
<ol>
<li><p>检查主题配置：确保主题的 _config.yml 文件中的配置正确，并已保存。</p>
</li>
<li><p>重启本地服务器：</p>
</li>
</ol>
<p>hexo server<br>进一步优化和扩展<br>SEO 优化<br>为了提高搜索引擎排名，可以进行以下 SEO 优化：</p>
<ol>
<li><p>设置 Meta 标签：在 _config.yml 中配置 meta 标签，如 title, description, keywords 等。</p>
</li>
<li><p>使用 SEO 插件：例如，安装 hexo-generator-seo-friendly-sitemap 和 hexo-generator-robots 插件：</p>
</li>
</ol>
<p>npm install hexo-generator-seo-friendly-sitemap hexo-generator-robots –save<br>并在 _config.yml 中进行相应配置：</p>
<p>sitemap:<br>  path: sitemap.xml</p>
<p>robots:<br>  useragent: *<br>  disallow:<br>分析和监控<br>为了了解博客的访问情况，可以集成分析工具，如 Google Analytics 或 Baidu Analytics。</p>
<p>集成 Google Analytics</p>
<ol>
<li><p>注册 Google Analytics：访问 Google Analytics[9]，并获取跟踪 ID。</p>
</li>
<li><p>配置 Hexo：在 _config.yml 中添加 Google Analytics 配置：</p>
</li>
</ol>
<p>google_analytics: UA-XXXXX-Y<br>集成 Baidu Analytics</p>
<ol>
<li><p>注册 Baidu Analytics：访问 Baidu Analytics[10]，并获取代码片段。</p>
</li>
<li><p>配置 Hexo：将代码片段添加到主题的 _config.yml 文件中，或直接修改主题的 layout&#x2F;_partial&#x2F; 文件。</p>
</li>
</ol>
<p>社交分享<br>增加社交分享按钮可以提升博客的互动性和传播度。</p>
<ol>
<li><p>选择插件：例如，使用 hexo-plugin-social-share 插件。</p>
</li>
<li><p>安装插件：</p>
</li>
</ol>
<p>npm install hexo-plugin-social-share –save</p>
<ol>
<li>配置插件：在 _config.yml 中添加社交分享配置：</li>
</ol>
<p>social_share:<br>  enable: true<br>  sites:<br>    - twitter<br>    - facebook<br>    - linkedin<br>总结<br>通过本文的详细指南，我们从零开始搭建了一个基于 Hexo 的个人博客，并通过 Docker 容器化技术进行了管理和部署。同时，我们还介绍了如何自定义博客主题、添加插件、优化性能以及解决常见问题。希望这些步骤能帮助你顺利搭建并管理一个专业的个人博客。</p>
<p>使用 Docker 和 Hexo，你可以快速、轻松地创建和维护一个个人博客，不仅展示你的技术和思想，还可以为你提供一个记录和分享的平台。赶快动手试试吧！</p>
<p>如果你有任何疑问或需要进一步的帮助，请随时在评论区留言，我们将尽力为你解答。Happy Blogging!</p>
<p>END</p>
<p>欢迎关注我的公众号</p>
<p>原创技术文章第一时间推送，点赞和在看就是最大的支持❤️</p>
<p>图片</p>
<p>点分享</p>
<p>图片</p>
<p>点收藏</p>
<p>图片</p>
<p>点点赞</p>
<p>图片</p>
<p>点在看</p>
<p>​</p>
<p>微信扫一扫<br>关注该公众号</p>
<p>人划线</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/06/09/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="英雄本色">
      <meta itemprop="description" content="英雄本色的博客，记录生活，分享感悟。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="英雄本色的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/09/hello-world/" class="post-title-link" itemprop="url">Hello World 你好，世界</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-06-09 16:18:02 / 修改时间：19:00:13" itemprop="dateCreated datePublished" datetime="2024-06-09T16:18:02+08:00">2024-06-09</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post-创建一篇博客"><a href="#Create-a-new-post-创建一篇博客" class="headerlink" title="Create a new post 创建一篇博客"></a>Create a new post 创建一篇博客</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server-运行服务器"><a href="#Run-server-运行服务器" class="headerlink" title="Run server 运行服务器"></a>Run server 运行服务器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">英雄本色</p>
  <div class="site-description" itemprop="description">英雄本色的博客，记录生活，分享感悟。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">7</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">英雄本色</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
